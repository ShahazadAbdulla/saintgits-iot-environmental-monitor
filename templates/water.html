<!DOCTYPE html>
<html>
<head>
    <title>Water Quality Dashboard</title>
    <!-- Use url_for to correctly link to the favicon in the static folder -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='saintgitslogo.jpg') }}" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- The custom center text plugin is used instead of the datalabels plugin -->
    <style>
        body {
            margin: 0;
            background: white;
            color: black;
            font-family: 'Segoe UI', sans-serif;
            text-align: center;
        }
        .NavBar {
             background-color: rgb(45, 44, 44);
             padding: 10px;
             position: fixed;
             top: 0;
             width: 100%;
             z-index: 1000;
             box-shadow: 0 0 15px rgba(0, 0, 0, 0.7);
             font-size: 16px;
             font-family: "Calibri New", sans-serif;
             color: white;
        }
        .NavBar table {
             width: 98%;
        }
        .NavBar td {
             vertical-align: middle;
        }
        .main-container {
             margin-top: 100px;
             padding: 20px;
        }
        .sensor-grid {
             display: flex;
             flex-wrap: wrap;
             gap: 25px;
             justify-content: center;
             align-items: flex-start;
             margin-bottom: 40px;
        }
        .gauge-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .gauge-wrapper h3 {
            margin-bottom: 5px;
            font-size: 1.1em;
            color: #333;
        }
        .gauge-container {
            width: 180px;
            height: 180px;
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .circular-gauge {
            width: 150px;
            height: 150px;
            position: relative;
        }
        .individual-charts-container {
             width: 90%;
             max-width: 1100px;
             margin: 20px auto;
             padding: 20px;
             background-color: #f0f0f0;
             border-radius: 15px;
             box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .charts-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
        }
        .mini-chart-wrapper {
            background-color: #fff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: calc(33.33% - 40px);
            min-width: 300px;
            height: 250px;
        }
        .mini-chart-wrapper h4 {
            margin-top: 0;
            margin-bottom: 10px;
        }
        .button-link {
             background-color: #d70707;
             color: white;
             padding: 10px 20px;
             border: none;
             border-radius: 6px;
             cursor: pointer;
             font-size: 16px;
             transition: 0.3s;
        }
        .button-link:hover {
             background-color: #4c0404;
             color: white;
        }
        footer {
             text-align: center;
             margin-top: 40px;
             padding: 15px;
             font-size: 14px;
             color: #000000;
             border-top: 1px solid #555;
        }
    </style>
</head>
<body>

    <div class="NavBar">
      <table>
        <tr>
            <td><h2>Saintgits Sensor Node - Water</h2></td>
            <td align="right">
                <!-- CORRECTED: Links now point to Flask routes -->
                <button class="button-link" onclick="location.href='/'">Front Page</button>
                <button class="button-link" onclick="location.href='/air'">Air Quality</button>
                <button class="button-link" onclick="location.href='/history'">History</button>
            </td>
        </tr>
      </table>
    </div>

    <div class="main-container">
        <div class="sensor-grid">
            <div class="gauge-wrapper">
                <h3>Water Level</h3>
                <div class="gauge-container">
                    <div class="circular-gauge">
                        <canvas id="level-gauge"></canvas>
                    </div>
                </div>
            </div>
            <div class="gauge-wrapper">
                <h3>Conductivity</h3>
                <div class="gauge-container">
                    <div class="circular-gauge">
                        <canvas id="conductivity-gauge"></canvas>
                    </div>
                </div>
            </div>
            <div class="gauge-wrapper">
                <h3>TDS</h3>
                <div class="gauge-container">
                    <div class="circular-gauge">
                        <canvas id="tds-gauge"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="individual-charts-container">
            <h2>Last 20 Sensor Readings</h2>
            <div class="charts-grid">
                <div class="mini-chart-wrapper"><h4>Water Level (%)</h4><canvas id="level-chart"></canvas></div>
                <div class="mini-chart-wrapper"><h4>Conductivity (µS/cm)</h4><canvas id="conductivity-chart"></canvas></div>
                <div class="mini-chart-wrapper"><h4>TDS (ppm)</h4><canvas id="tds-chart"></canvas></div>
            </div>
        </div>
    </div>

    <footer>
        Developed by Taiwan ICC Interns
    </footer>

<script>
    const centerTextPlugin = {
        id: 'centerText',
        afterDraw: (chart) => {
            if (chart.config.type !== 'doughnut') return;
            const ctx = chart.ctx;
            const { width, height } = chart;
            const unit = chart.config.options.plugins.centerText.unit || '';
            const value = chart.data.datasets[0].data[0];
            
            ctx.restore();
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.font = 'bold 24px Segoe UI';
            ctx.fillStyle = '#333';
            ctx.fillText(value.toFixed(1), width / 2, height / 2 - 10);
            ctx.font = '16px Segoe UI';
            ctx.fillStyle = '#666';
            ctx.fillText(unit, width / 2, height / 2 + 15);
            ctx.save();
        }
    };
    Chart.register(centerTextPlugin);

    const GAUGE_MAX_VALUES = {
        level: 100,
        conductivity: 3000,
        tds: 2000
    };

    let charts = {};

    function createCircularGauge(canvasId, unit, max) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        return new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [0, max], backgroundColor: ['#007bff', '#e9e9e9'],
                    borderWidth: 0, circumference: 270, rotation: 225,
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false, cutout: '75%',
                plugins: {
                    legend: { display: false }, tooltip: { enabled: false },
                    centerText: { unit: unit }
                }
            }
        });
    }

    function createIndividualChart(canvasId, color, label) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        return new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: label,
                    data: [], borderColor: color,
                    tension: 0.3, fill: true, backgroundColor: color + '33', pointRadius: 2
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: false, title: {display: true, text: label} } }
            }
        });
    }

    function updateCircularGauge(chart, value, max) {
        const numericValue = parseFloat(value) || 0;
        chart.data.datasets[0].data[0] = numericValue;
        chart.data.datasets[0].data[1] = Math.max(0, max - numericValue);
        chart.update('none');
    }

    function updateIndividualChart(chart, labels, data) {
        chart.data.labels = labels;
        chart.data.datasets[0].data = data;
        chart.update();
    }

    async function fetchData() {
        try {
            const latestResponse = await fetch('/get_latest_water_data');
            if (!latestResponse.ok) throw new Error('Latest data fetch failed');
            const latestDataArray = await latestResponse.json();

            if (latestDataArray && latestDataArray.length > 0) {
                const latest = latestDataArray[0];
                updateCircularGauge(charts.levelGauge, latest.water_level_pct, GAUGE_MAX_VALUES.level);
                updateCircularGauge(charts.conductivityGauge, latest.conductivity_us_cm, GAUGE_MAX_VALUES.conductivity);
                updateCircularGauge(charts.tdsGauge, latest.tds_ppm, GAUGE_MAX_VALUES.tds);
            }

            const historyResponse = await fetch('/get_water_history');
            if (!historyResponse.ok) throw new Error('History data fetch failed');
            const historyData = await historyResponse.json();

            if (historyData && historyData.length > 0) {
                const labels = historyData.map(d => d.time_label);
                updateIndividualChart(charts.levelChart, labels, historyData.map(d => d.water_level_pct));
                updateIndividualChart(charts.conductivityChart, labels, historyData.map(d => d.conductivity_us_cm));
                updateIndividualChart(charts.tdsChart, labels, historyData.map(d => d.tds_ppm));
            }

        } catch (error) {
            console.error("Failed to fetch water data:", error);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        charts.levelGauge = createCircularGauge('level-gauge', '%', GAUGE_MAX_VALUES.level);
        charts.conductivityGauge = createCircularGauge('conductivity-gauge', 'µS/cm', GAUGE_MAX_VALUES.conductivity);
        // CORRECTED: Changed 'ppm-gauge' to 'tds-gauge'
        charts.tdsGauge = createCircularGauge('tds-gauge', 'ppm', GAUGE_MAX_VALUES.tds);

        charts.levelChart = createIndividualChart('level-chart', '#36a2eb', 'Water Level (%)');
        charts.conductivityChart = createIndividualChart('conductivity-chart', '#ff6384', 'Conductivity (µS/cm)');
        // CORRECTED: Changed 'ppm-chart' to 'tds-chart'
        charts.tdsChart = createIndividualChart('tds-chart', '#4bc0c0', 'TDS (ppm)');

        fetchData();
        setInterval(fetchData, 5000);
    });
</script>

</body>
</html>
