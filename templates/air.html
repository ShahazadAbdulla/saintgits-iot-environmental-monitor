<!DOCTYPE html>
<html>
<head>
    <title>Air Quality Dashboard</title>
    <!-- Use url_for to correctly link to the favicon in the static folder -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='saintgitslogo.jpg') }}" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- The custom center text plugin makes the datalabels plugin unnecessary -->
    <style>
        body {
            margin: 0;
            background: white;
            color: black;
            font-family: 'Segoe UI', sans-serif;
            text-align: center;
        }
        .NavBar {
             background-color: rgb(45, 44, 44);
             padding: 10px;
             position: fixed;
             top: 0;
             width: 100%;
             z-index: 1000;
             box-shadow: 0 0 15px rgba(0, 0, 0, 0.7);
             font-size: 16px;
             font-family: "Calibri New", sans-serif;
             color: white;
        }
        .NavBar table {
             width: 98%;
        }
        .NavBar td {
             vertical-align: middle;
        }
        .main-container {
             margin-top: 100px;
             padding: 20px;
        }
        .sensor-grid {
             display: flex;
             flex-wrap: wrap;
             gap: 25px;
             justify-content: center;
             align-items: flex-start;
             margin-bottom: 40px;
        }
        .gauge-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .gauge-wrapper h3 {
            margin-bottom: 5px;
            font-size: 1.1em;
            color: #333;
        }
        .gauge-container {
            width: 180px;
            height: 180px;
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .circular-gauge { width: 150px; height: 150px; position: relative; }
        .bar-gauge-content { display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; }
        .bar-gauge { width: 50px; height: 120px; border: 2px solid #ccc; border-radius: 10px; background-color: #e9e9e9; display: flex; flex-direction: column-reverse; overflow: hidden; margin-bottom: 5px; }
        .bar-gauge-fill { width: 100%; background-color: #007bff; transition: height 0.5s ease-in-out; }
        #pm25-value, #pm10-value { font-weight: bold; font-size: 0.9em; }

        .individual-charts-container {
             width: 90%;
             max-width: 1100px;
             margin: 20px auto;
             padding: 20px;
             background-color: #f0f0f0;
             border-radius: 15px;
             box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .charts-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
        }
        .mini-chart-wrapper {
            background-color: #fff;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: calc(33.33% - 40px);
            min-width: 300px;
            height: 250px;
        }
        .mini-chart-wrapper h4 {
            margin-top: 0;
            margin-bottom: 10px;
        }
        .button-link {
             background-color: #d70707;
             color: white;
             padding: 10px 20px;
             border: none;
             border-radius: 6px;
             cursor: pointer;
             font-size: 16px;
             transition: background-color 0.3s;
        }
        .button-link:hover {
             background-color: #4c0404;
             color: white;
        }
        footer {
             text-align: center;
             margin-top: 40px;
             padding: 15px;
             font-size: 14px;
             color: #000000;
             border-top: 1px solid #555;
        }
    </style>
</head>
<body>

<div class="NavBar">
  <table>
    <tr>
        <td><h2>Saintgits Sensor Node</h2></td>
        <td align="right">
            <button class="button-link" onclick="location.href='/'">Front Page</button>
            <button class="button-link" onclick="location.href='/history'">History</button>
        </td>
    </tr>
  </table>
</div>

    <div class="main-container">
        <div class="sensor-grid">
            <div class="gauge-wrapper">
                <h3>Humidity</h3>
                <div class="gauge-container"><div class="circular-gauge"><canvas id="humidity-gauge"></canvas></div></div>
            </div>
            <div class="gauge-wrapper">
                <h3>Temperature</h3>
                <div class="gauge-container"><div class="circular-gauge"><canvas id="temp-gauge"></canvas></div></div>
            </div>
            <div class="gauge-wrapper">
                <h3>PM 2.5</h3>
                <div class="gauge-container"><div class="bar-gauge-content"><div class="bar-gauge"><div class="bar-gauge-fill" id="pm25-bar"></div></div><div id="pm25-value">-- µg/m³</div></div></div>
            </div>
            <div class="gauge-wrapper">
                <h3>PM 10</h3>
                <div class="gauge-container"><div class="bar-gauge-content"><div class="bar-gauge"><div class="bar-gauge-fill" id="pm10-bar"></div></div><div id="pm10-value">-- µg/m³</div></div></div>
            </div>
            <div class="gauge-wrapper">
                <h3>Wind Speed</h3>
                <div class="gauge-container"><div class="circular-gauge"><canvas id="wind-gauge"></canvas></div></div>
            </div>
            <div class="gauge-wrapper">
                <h3>Rain</h3>
                <div class="gauge-container"><div class="circular-gauge"><canvas id="rain-gauge"></canvas></div></div>
            </div>
        </div>

        <div class="individual-charts-container">
            <h2>Last 20 Sensor Readings</h2>
            <div class="charts-grid">
                <div class="mini-chart-wrapper"><h4>Temperature (°C)</h4><canvas id="temp-chart"></canvas></div>
                <div class="mini-chart-wrapper"><h4>Humidity (%)</h4><canvas id="humidity-chart"></canvas></div>
                <div class="mini-chart-wrapper"><h4>Wind Speed (m/s)</h4><canvas id="wind-chart"></canvas></div>
                <div class="mini-chart-wrapper"><h4>Rain (mm)</h4><canvas id="rain-chart"></canvas></div>
                <div class="mini-chart-wrapper"><h4>PM 2.5 (µg/m³)</h4><canvas id="pm25-chart"></canvas></div>
                <div class="mini-chart-wrapper"><h4>PM 10 (µg/m³)</h4><canvas id="pm10-chart"></canvas></div>
            </div>
        </div>
    </div>

    <footer>
        Developed by Taiwan ICC Interns
    </footer>

<script>
    const centerTextPlugin = {
        id: 'centerText',
        afterDraw: (chart) => {
            if (chart.config.type !== 'doughnut') return;
            const ctx = chart.ctx;
            const { width, height } = chart;
            const unit = chart.config.options.plugins.centerText.unit || '';
            const value = chart.data.datasets[0].data[0];
            
            ctx.restore();
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.font = 'bold 24px Segoe UI';
            ctx.fillStyle = '#333';
            ctx.fillText(value.toFixed(1), width / 2, height / 2 - 10);
            ctx.font = '16px Segoe UI';
            ctx.fillStyle = '#666';
            ctx.fillText(unit, width / 2, height / 2 + 15);
            ctx.save();
        }
    };
    Chart.register(centerTextPlugin);

    const GAUGE_MAX_VALUES = {
        humidity: 100, temperature: 50, wind: 30,
        rain: 25, pm25: 100, pm10: 150
    };

    let charts = {};

    function createCircularGauge(canvasId, unit, max) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        return new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [0, max], backgroundColor: ['#007bff', '#e9e9e9'],
                    borderWidth: 0, circumference: 270, rotation: 225,
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false, cutout: '75%',
                plugins: {
                    legend: { display: false }, tooltip: { enabled: false },
                    centerText: { unit: unit }
                }
            }
        });
    }

    function createIndividualChart(canvasId, color) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        return new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    data: [], borderColor: color,
                    tension: 0.3, fill: false, pointRadius: 2
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: { y: { beginAtZero: false } }
            }
        });
    }

    function updateCircularGauge(chart, value, max) {
        const numericValue = parseFloat(value) || 0;
        chart.data.datasets[0].data[0] = numericValue;
        chart.data.datasets[0].data[1] = Math.max(0, max - numericValue);
        chart.update('none');
    }

    function updateBarGauge(barId, valueId, value, max, unit) {
        const numericValue = parseFloat(value) || 0;
        const percentage = Math.min(100, (numericValue / max) * 100);
        document.getElementById(barId).style.height = percentage + '%';
        document.getElementById(valueId).textContent = numericValue.toFixed(1) + unit;
    }

    function updateIndividualChart(chart, labels, data) {
        chart.data.labels = labels;
        chart.data.datasets[0].data = data;
        chart.update();
    }

    async function fetchData() {
        try {
            const latestResponse = await fetch('/get_latest_data');
            if (!latestResponse.ok) throw new Error('Latest data fetch failed');
            const latestDataArray = await latestResponse.json();

            if (latestDataArray && latestDataArray.length > 0) {
                const latest = latestDataArray[0];
                updateCircularGauge(charts.humidityGauge, latest.humidity_pct, GAUGE_MAX_VALUES.humidity);
                updateCircularGauge(charts.tempGauge, latest.temperature_c, GAUGE_MAX_VALUES.temperature);
                updateCircularGauge(charts.windGauge, latest.wind_speed_ms, GAUGE_MAX_VALUES.wind);
                updateCircularGauge(charts.rainGauge, latest.rain_level_mm, GAUGE_MAX_VALUES.rain);
                updateBarGauge('pm25-bar', 'pm25-value', latest.pm2_5_ug_m3, GAUGE_MAX_VALUES.pm25, ' µg/m³');
                updateBarGauge('pm10-bar', 'pm10-value', latest.pm10_ug_m3, GAUGE_MAX_VALUES.pm10, ' µg/m³');
            }

            const historyResponse = await fetch('/get_history');
            if (!historyResponse.ok) throw new Error('History data fetch failed');
            const historyData = await historyResponse.json();

            if (historyData && historyData.length > 0) {
                const labels = historyData.map(d => d.time_label);
                updateIndividualChart(charts.tempChart, labels, historyData.map(d => d.temperature_c));
                updateIndividualChart(charts.humidityChart, labels, historyData.map(d => d.humidity_pct));
                updateIndividualChart(charts.windChart, labels, historyData.map(d => d.wind_speed_ms));
                updateIndividualChart(charts.rainChart, labels, historyData.map(d => d.rain_level_mm));
                updateIndividualChart(charts.pm25Chart, labels, historyData.map(d => d.pm2_5_ug_m3));
                updateIndividualChart(charts.pm10Chart, labels, historyData.map(d => d.pm10_ug_m3));
            }

        } catch (error) {
            console.error("Failed to fetch or update data:", error);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        charts.humidityGauge = createCircularGauge('humidity-gauge', '%', GAUGE_MAX_VALUES.humidity);
        charts.tempGauge = createCircularGauge('temp-gauge', '°C', GAUGE_MAX_VALUES.temperature);
        charts.windGauge = createCircularGauge('wind-gauge', 'm/s', GAUGE_MAX_VALUES.wind);
        charts.rainGauge = createCircularGauge('rain-gauge', 'mm', GAUGE_MAX_VALUES.rain);

        charts.tempChart = createIndividualChart('temp-chart', '#ff6384');
        charts.humidityChart = createIndividualChart('humidity-chart', '#36a2eb');
        charts.windChart = createIndividualChart('wind-chart', '#cc65fe');
        charts.rainChart = createIndividualChart('rain-chart', '#4bc0c0');
        charts.pm25Chart = createIndividualChart('pm25-chart', '#ff9f40');
        charts.pm10Chart = createIndividualChart('pm10-chart', '#ffcd56');

        fetchData();
        setInterval(fetchData, 5000);
    });
</script>

</body>
</html>
